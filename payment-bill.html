<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduWriteX Employee Payment Bill</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jsPDF library for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #f8fafd; }
    .form-container {
      box-shadow: 0 4px 24px 0 rgba(26,115,232,0.08), 0 1.5px 4px 0 rgba(26,115,232,0.08);
      border: 1px solid #e3e3e3;
      background: #fff;
      max-width: 480px;
      margin: 32px auto 0 auto;
      padding: 2rem 1.5rem !important;
      border-radius: 18px;
    }
    .form-container input, .form-container select {
      background: #fff;
      border-radius: 8px;
      border: 1px solid #dbeafe;
      box-shadow: none;
      transition: border-color 0.2s;
    }
    .form-container input:focus, .form-container select:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 0.15rem rgba(26,115,232,0.10);
    }
    .form-container label {
      font-weight: 500;
      color: #1a73e8;
      margin-bottom: 0.25rem;
    }
    .form-container .btn-primary {
      border-radius: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px 0 rgba(26,115,232,0.08);
      background: linear-gradient(90deg, #1a73e8 60%, #4fc3f7 100%);
      border: none;
    }
    .form-container .btn-primary:hover {
      background: linear-gradient(90deg, #1761c6 60%, #039be5 100%);
    }
    .result-box {
      background: #f4faff;
      border: 1px solid #e3e3e3;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <h2 class="text-center mb-4 text-primary">Employee Payment Bill</h2>
    <form class="form-container" id="paymentForm">
      <div class="mb-3">
        <label for="employeeName">Employee Name</label>
        <input type="text" id="employeeName" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="bankAcc">Bank Account Number</label>
        <input type="text" id="bankAcc" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="bankName">Bank Name</label>
        <input type="text" id="bankName" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="bankBranch">Bank Branch <span class="text-muted">(optional)</span></label>
        <input type="text" id="bankBranch" class="form-control" />
      </div>
      <div class="work-items-section mb-3" id="workItemsSection">
        <h5 class="text-primary mb-3">Work Items</h5>
        <div id="workItemsContainer">
          <div class="work-item-row mb-3 p-3 border rounded bg-light">
            <div class="mb-3">
              <label for="orderId">Order ID</label>
              <input type="text" class="form-control order-id" placeholder="#001" value="#001" required />
            </div>
            <div class="mb-3">
              <label for="serviceType">Service Type</label>
              <select class="form-select service-type" required>
                <option value="Typing Service">Typing Service</option>
                <option value="Service Assignment">Service Assignment</option>
                <option value="Assignment Service">Assignment Service</option>
                <option value="Editing Service">Editing Service</option>
                <option value="Translation Service">Translation Service</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label for="pages">Number of Pages/Words</label>
                <input type="number" class="form-control pages" min="1" required />
              </div>
              <div class="col-6">
                <label for="pricePerUnit">Price per Page/Word</label>
                <input type="number" class="form-control price-per-unit" min="0" required />
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-primary add-work-btn" onclick="addWorkItem()">
          + Add Another Work Item
        </button>
      </div>
      <div class="mb-3">
        <label for="advance">Advance Amount <span class="text-muted">(if any)</span></label>
        <input type="number" id="advance" class="form-control" min="0" value="0" />
      </div>
      <div class="d-flex gap-2">
  <button type="button" class="btn btn-primary w-100" onclick="calculateBill()">Calculate Bill</button>
  <button type="button" class="btn btn-success w-100" onclick="generateFinalBill()">Generate Final Bill</button>
  <button type="button" class="btn btn-outline-info w-100" onclick="exportPDF('final')">Export PDF</button>
  <button type="button" class="btn btn-outline-warning w-100" onclick="exportPDF('advance')">Export Advance Bill PDF</button>
      </div>
    </form>
    <div id="resultBox" class="result-box" style="display:none;"></div>
  </div>
  <script>
    function addWorkItem() {
      const container = document.getElementById('workItemsContainer');
      const currentItems = container.querySelectorAll('.work-item-row').length;
      const nextOrderId = `#${String(currentItems + 1).padStart(3, '0')}`;
      
      const newRow = document.createElement('div');
      newRow.className = 'work-item-row mb-3 p-3 border rounded bg-light';
      newRow.innerHTML = `
        <div class="mb-3">
          <label>Order ID</label>
          <input type="text" class="form-control order-id" placeholder="${nextOrderId}" value="${nextOrderId}" required />
        </div>
        <div class="mb-3">
          <label>Service Type</label>
          <select class="form-select service-type" required>
            <option value="Typing Service">Typing Service</option>
            <option value="Service Assignment">Service Assignment</option>
            <option value="Assignment Service">Assignment Service</option>
            <option value="Editing Service">Editing Service</option>
            <option value="Translation Service">Translation Service</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label>Number of Pages/Words</label>
            <input type="number" class="form-control pages" min="1" required />
          </div>
          <div class="col-6">
            <label>Price per Page/Word</label>
            <input type="number" class="form-control price-per-unit" min="0" required />
          </div>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm mt-2" onclick="this.closest('.work-item-row').remove()">
          Remove Work Item
        </button>
      `;
      container.appendChild(newRow);
    }

    function getWorkItems() {
      const items = [];
      const workRows = document.querySelectorAll('.work-item-row');
      
      workRows.forEach(row => {
        const orderId = row.querySelector('.order-id').value;
        const serviceType = row.querySelector('.service-type').value;
        const pages = parseInt(row.querySelector('.pages').value) || 0;
        const pricePerUnit = parseFloat(row.querySelector('.price-per-unit').value) || 0;
        
        if (orderId && pages > 0 && pricePerUnit > 0) {
          items.push({
            orderId,
            serviceType,
            pages,
            pricePerUnit,
            total: pages * pricePerUnit
          });
        }
      });
      
      return items;
    }

    function calculateBill() {
      const workItems = getWorkItems();
      const advance = +document.getElementById('advance').value;
      
      if (workItems.length === 0) {
        alert('Please add at least one work item');
        return;
      }
      
      const total = workItems.reduce((sum, item) => sum + item.total, 0);
      const remaining = total - advance;
      
      let html = `<strong>Total Payment:</strong> Rs. ${total.toFixed(2)}<br/>`;
      html += `<strong>Work Items:</strong> ${workItems.length}<br/>`;
      if (advance > 0) {
        html += `<strong>Advance Paid:</strong> Rs. ${advance.toFixed(2)}<br/>`;
        html += `<strong>Remaining Amount:</strong> Rs. ${remaining.toFixed(2)}`;
      }
      document.getElementById('resultBox').innerHTML = html;
      document.getElementById('resultBox').style.display = 'block';
    }

    function generateFinalBill() {
      calculateBill();
      exportPDF('final');
    }

    function exportPDF(type) {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert('❌ PDF export failed: jsPDF library not loaded.');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const employeeName = document.getElementById('employeeName').value;
      const bankAcc = document.getElementById('bankAcc').value;
      const bankName = document.getElementById('bankName').value;
      const bankBranch = document.getElementById('bankBranch').value;
      const workItems = getWorkItems();
      const advance = +document.getElementById('advance').value;
      const total = workItems.reduce((sum, item) => sum + item.total, 0);
      const remaining = total - advance;
      const currentDate = new Date().toLocaleDateString();
      const billType = type === 'advance' ? 'Advance Payment Bill' : 'Final Payment Bill';

      if (workItems.length === 0) {
        alert('❌ Please add at least one work item');
        return;
      }

      if (type === 'advance' && advance <= 0) {
        alert('❌ Please enter a valid advance amount to export an advance bill.');
        return;
      }

      // Load logo and generate PDF after logo loads
      const logoImg = new Image();
      logoImg.src = 'logo.png';
      logoImg.onload = function () {
        // Add Logo (x, y, width, height)
        doc.addImage(logoImg, 'PNG', 80, 10, 50, 20);

        // Header text
        doc.setFontSize(18);
        doc.setTextColor(0, 0, 0);
        doc.text('INVOICE', 105, 40, { align: 'center' });

        // Bill type
        doc.setFontSize(12);
        doc.setTextColor(26, 115, 232);
        doc.text(billType, 105, 50, { align: 'center' });

        // Invoice details
        doc.setFontSize(10);
        doc.setTextColor(0,0,0);
        doc.text(`Date: ${currentDate}`, 20, 60);
        doc.text(`Employee Name: ${employeeName}`, 20, 68);
        doc.text(`Bank Acc No: ${bankAcc}`, 20, 76);
        doc.text(`Bank: ${bankName}`, 20, 84);
        if (bankBranch) doc.text(`Branch: ${bankBranch}`, 20, 92);

        // Service details table
        let y = bankBranch ? 102 : 94;
        doc.setFont('helvetica', 'bold');
        doc.text('Service Details:', 20, y);
        doc.setFont('helvetica', 'normal');
        doc.text('Order ID', 20, y+10);
        doc.text('Description', 55, y+10);
        doc.text('Pages/Words', 95, y+10);
        doc.text('Rate/Unit', 130, y+10);
        doc.text('Amount', 170, y+10);
        doc.line(20, y+13, 190, y+13);

        // Work items
        let currentY = y+22;
        doc.setFont('helvetica', 'normal');
        
        workItems.forEach((item) => {
          doc.text(item.orderId, 20, currentY);
          doc.text(item.serviceType, 55, currentY);
          doc.text(item.pages.toString(), 100, currentY);
          doc.text(`Rs. ${item.pricePerUnit.toFixed(2)}`, 130, currentY);
          doc.text(`Rs. ${item.total.toFixed(2)}`, 170, currentY);
          currentY += 10;
        });

        // Subtotal line
        doc.line(20, currentY, 190, currentY);
        currentY += 10;

        // Total
        doc.setFont('helvetica', 'bold');
        doc.text(`Services Total: Rs. ${total.toFixed(2)}`, 170, currentY, { align: 'right' });
        currentY += 15;

        // Advance/Final Details
        if (type === 'advance') {
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(255, 140, 0);
          doc.text(`Advance Paid: Rs. ${advance.toFixed(2)}`, 20, currentY);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(0,0,0);
          doc.text('This is an advance payment bill. Remaining amount will be shown in the final bill.', 20, currentY+10);
        } else {
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(34, 197, 94);
          doc.text(`Advance Paid: Rs. ${advance.toFixed(2)}`, 20, currentY);
          doc.text(`Remaining Amount: Rs. ${remaining.toFixed(2)}`, 20, currentY+10);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(0,0,0);
          doc.text('This is the final payment bill after deducting advance.', 20, currentY+20);
        }

        // Footer
        doc.setFontSize(10);
        doc.setTextColor(102, 102, 102);
        doc.text('This is a computer-generated receipt.', 105, 270, { align: 'center' });
        doc.text('Contact us 078 8341315 | 076 571 3385 | edu.WriteX@gmail.com', 105, 278, { align: 'center' });
        doc.text('© EduWriteX', 105, 286, { align: 'center' });

        // Save PDF
        let fileName = `EduWriteX_PaymentBill_${employeeName.replace(/\s+/g,'_')}_${billType.replace(/\s+/g,'_')}_${currentDate}.pdf`;
        doc.save(fileName);
        alert('✅ PDF exported: ' + fileName);
      };
      logoImg.onerror = function () {
        alert("⚠️ Could not load logo. Please check if 'logo.png' is available in the same folder.");
      };
    }
  </script>
</body>
</html>
